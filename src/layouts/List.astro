---
import MarkdownIt from 'markdown-it';
import { parse as parseHtml } from 'node-html-parser';

import WithProfileLayout from '@/layouts/WithProfile.astro';
import PostCard from '@/components/post/PostCard.astro';
import Footer from '@/components/Footer.vue';

const parser = MarkdownIt();
function getExcerpt(body: string) {
  const html = parser.render(body);
  const root = parseHtml(html);
  const text = root.getElementsByTagName('p')[0]?.text;
  if (!text || text.length <= 400) return text;
  return text.substring(0, 400) + ' ...';
}

const {
  title,
  desc,
  category,
  page,
  prefix,
} = Astro.props;

const posts = page.data.map(({ collection, id, body, data }) => ({
  collection: collection,
  id: id,
  excerpt: body ? getExcerpt(body) : '',
  title: data.title,
  desc: data.desc,
  date: data.date,
  tags: data.tags,
  banner_url: data.banner_url,
}));
---

<WithProfileLayout {title} {desc}>
  <main class="px-8">
    {/* Category */}
    { category && <h1 class="my-10 text-2xl">{category}</h1> }

    {/* Post List */}
    <div class="pb-3">
      {
        posts.length === 0 &&
          <div class="my-4">
            <div class="i-mdi-sign-caution mx-auto text-[10rem]" />
            <div class="text-center text-3xl">There'll be something one day...</div>
          </div> ||
          posts.map(post => <PostCard {...post} />)
      }
    </div>

    {/* Pagination */}
    <div class="flex justify-center items-center">
      <a
        href={page.url.prev}
        class:list={[
          'mr-1',
          { 'invisible': !page.url.prev },
        ]}
      >
        <div class="i-mdi-menu-left menu-btn" />
      </a>
      {
        /* show at most 5 page links (2 previous pages, current page and 2 next pages) */
        Array.from({ length: 5 }, (_, k) => k + page.currentPage - 2).map(num =>
          num <= 0 || num > page.lastPage ?
            /* out of range; create a placeholder */
            <span class="mx-1 w-9 text-lg" /> :
          num == page.currentPage ?
            /* current page */
            <span
              class="
                page-link
                border-indicator-catchy
              "
            >{num}</span> :
            /* other pages */
            <a
              href={`${prefix}/${num}`}
              class="
                page-link
                border-transparent
                transition-colors duration-200
                hover:border-indicator-catchy/50
              "
            >{num}</a>
        )
      }
      <a
        href={page.url.next}
        class:list={[
          'ml-1',
          { 'invisible': !page.url.next },
        ]}
      >
        <div class="i-mdi-menu-right menu-btn" />
      </a>
    </div>
  </main>
  <Footer />
</WithProfileLayout>

<style>
.page-link {
  @apply mx-1 w-9 h-9;
  @apply rounded-full border-2;
  @apply text-lg text-center;
}

.menu-btn {
  @apply text-4xl;
  @apply transition-transform duration-200;
  @apply hover:scale-120%;
  @apply active:scale-80%;
}
</style>