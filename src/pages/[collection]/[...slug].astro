---
import type { GetStaticPaths } from 'astro';
import { getCollection, render } from 'astro:content';
import type { CollectionEntry, CollectionKey } from 'astro:content';

import PostLayout from '@/layouts/Post.astro';
import Link from '@/components/element/Link.vue';
import PostImage from '@/components/element/PostImage.astro';
import Group from '@/components/element/Group.vue';
import GitHubCard from '@/components/element/GitHubCard.vue';

import { collections } from '@/content.config.ts';

interface Props {
  post: CollectionEntry<CollectionKey>;
}

export const getStaticPaths: GetStaticPaths = async () => {
  const all_posts = await Promise.all(
    Object.keys(collections).map(async (collection) => {
      const posts = await getCollection(collection as CollectionKey);
      return posts ?
        posts.map(post => ({
          params: { collection, slug: post.id },
          props: { post },
        })) : [];
    })
  );
  return all_posts.flat();
}

const { post } = Astro.props;
const { Content, headings } = await render(post);
---

<PostLayout {...post.data} {headings}>
  <article>
    <Content
      components={{
        a: Link,
        img: PostImage,
        Group,
        GitHubCard,
      }}
    />
  </article>
</PostLayout>

<style>
article {
  h1 {
    @apply text-2xl;
  }
  h2 {
    @apply text-xl;
  }
  h3 {
    @apply text-lg;
  }
  h1, h2, h3, h4, h5, h6 {
    @apply margin-content;
  }

  p, img {
    @apply margin-content;
  }

  a {
    @apply underline;
  }

  ol {
    @apply margin-content;
    @apply pl-8;
    @apply list-decimal;
  }
  ol ol {
    @apply list-alpha;
  }
  ol ol ol {
    @apply list-roman:
  }
  ul {
    @apply margin-content;
    @apply pl-8;
    @apply list-disc;
  }
  ul ul {
    @apply list-circle;
  }
  ul ul ul {
    @apply list-square;
  }
  li {
    @apply leading-8;
    * {
      @apply mb-0!;
    }
  }

  dl {
    @apply margin-content;
    dt {
      @apply mt-2;
      @apply font-bold font-italic;
    }
    dd {
      @apply pl-8;
    }
  }

  table {
    @apply mx-auto margin-content;
    th, td {
      @apply px-8 py-2;
      @apply border-0;
    }
    td {
      @apply border-t-1;
    }
    tr {
      @apply hover:bg-indicator-catchy/10;
    }
  }

  /* inline code */
  code:not(pre code) {
    @apply px-1;
    @apply rounded-md;
    @apply bg-bg-muted;
    @apply text-indicator-catchy;
    @apply whitespace-pre-wrap;
    @apply break-all;
  }
  /* code block */
  pre {
    @apply md:w-90%;
    @apply margin-content;
    @apply pa-4;
    @apply rounded-lg;
  }

  blockquote {
    @apply md:w-90%;
    @apply margin-content;
    @apply pa-4;
    @apply border-l-4 border-l-indicator-info;
    @apply bg-bg-card;
  }

  [data-callout] {
    @apply md:w-90%;
    @apply margin-content;
    @apply pa-4;
    @apply rounded-lg;

    [data-callout-title] {
      @apply flex items-center;
      @apply pb-2;
      @apply font-700;
    }
    html:not(.dark) & [data-callout-title] {
      @apply brightness-70;
    }
    [data-callout-body] {
      @apply px-4;
    }
  }
  [data-callout-type="info"] {
    @apply bg-indicator-info/15;

    [data-callout-title]::before {
      content: '';
      @apply i-mdi-information;
      @apply bg-indicator-info;
    }
    [data-callout-title] {
      @apply text-indicator-info;
    }
  }
  [data-callout-type="hint"] {
    @apply bg-indicator-hint/15;

    [data-callout-title]::before {
      content: '';
      @apply i-mdi-bulb;
      @apply bg-indicator-hint;
    }
    [data-callout-title] {
      @apply text-indicator-hint;
    }
  }
  [data-callout-type="warning"] {
    @apply bg-indicator-warning/15;

    [data-callout-title]::before {
      content: '';
      @apply i-mdi-alert;
      @apply bg-indicator-warning;
    }
    [data-callout-title] {
      @apply text-indicator-warning;
    }
  }
  [data-callout-type="error"] {
    @apply bg-indicator-error/15;

    [data-callout-title]::before {
      content: '';
      @apply i-mdi-close-circle;
      @apply bg-indicator-error;
    }
    [data-callout-title] {
      @apply text-indicator-error;
    }
  }

  hr {
    @apply my-6;
    @apply border-1 border-dashed;
  }
}
</style>