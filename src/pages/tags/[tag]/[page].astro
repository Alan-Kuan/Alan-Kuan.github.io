---
import { getCollection } from 'astro:content';

import IndexLayout from '@/layouts/Index.astro';
import { post_collection_names } from '@/content/config.ts';

export async function getStaticPaths({ paginate }) {
  const all_posts = await Promise.all(
    post_collection_names.map(async (collection) => await getCollection(collection) ?? [])
  );
  const posts = all_posts.flat()
    .sort((a, b) => Date.parse(b.data.date) - Date.parse(a.data.date));
  const unique_tags = [...new Set(posts.map(({ data }) => data.tags).flat())];

  return unique_tags.map(tag => {
    const filtered_posts = posts.filter(({ data }) => data.tags.includes(tag));
    return paginate(filtered_posts, { pageSize: 8, params: { tag } });
  }).flat();
}

const { tag } = Astro.params;
const { page } = Astro.props;

const title = 'Alan Kuan | 官澔恩';
const desc = `Posts tagged with "${tag}"`;
---

<IndexLayout
  {title}
  {desc}
  {page}
  prefix={`/tags/${tag}`}
/>