---
import type { GetStaticPaths, Page } from 'astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry, CollectionKey } from 'astro:content';

import ListLayout from '@/layouts/List.astro';

import { byDate } from '@/post_sorting.ts';

interface Props {
  page: Page<CollectionEntry<CollectionKey>>;
}

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const collection_names = ['articles', 'projects'];
  const all_posts = await Promise.all(
    collection_names.map(async (collection) =>
      await getCollection(collection as CollectionKey) ?? [])
  );
  const posts = all_posts.flat().sort((a, b) => byDate(a, b));
  const unique_tags = [...new Set(posts.map(({ data }) => data.tags).flat())];

  return unique_tags.map(tag => {
    const filtered_posts = posts.filter(({ data }) => data.tags.includes(tag));
    return paginate(filtered_posts, { pageSize: 8, params: { tag } });
  }).flat();
}

const { tag } = Astro.params;
const { page } = Astro.props;

const props = {
  title: 'Alan Kuan | 官澔恩',
  desc: `Posts tagged with "${tag}"`,
  category: `Tag: ${tag}`,
  page,
  prefix: `/tags/${tag}`,
}
---

<ListLayout {...props} />